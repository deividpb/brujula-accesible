<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Brújula Accesible Mejorada</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family:sans-serif; text-align:center; background:#f0f0f0; }
#startBtn { font-size:2em; padding:1em; margin-top:2em; }
#compass { margin:2em auto; width:300px; height:300px; position:relative; border:5px solid #333; border-radius:50%; background:radial-gradient(circle at center,#fff 70%,#ddd 100%); }
#needle { width:4px; height:140px; background:red; position:absolute; top:10px; left:50%; transform-origin:bottom center; transform:rotate(0deg); }
.cardinal { position:absolute; font-weight:bold; font-size:1.2em; transform:translate(-50%,-50%); }
#directionText { font-size:2em; margin-top:1em; }
</style>
</head>
<body>

<button id="startBtn">Tocar para comenzar</button>
<div id="compass" style="display:none;">
  <div id="needle"></div>
</div>
<div id="directionText"></div>

<script>
let lastAngle = null;
let currentCardinal = null;
let speakInterval = null;

// --- AUDIO ---
let audioCtx = null;
let mainTone = null; // sonido principal
let modulator = null; // para pitido intermitente derecha
let modGain = null;

const STABLE_THRESHOLD = 2; // grados para considerar estable
const CARDINAL_REPEAT_INTERVAL = 4000;
const CARDINALS = [
  { name:"N", angle:0 },
  { name:"NE", angle:45 },
  { name:"E", angle:90 },
  { name:"SE", angle:135 },
  { name:"S", angle:180 },
  { name:"SO", angle:225 },
  { name:"O", angle:270 },
  { name:"NO", angle:315 }
];

// --- VOZ ---
function speak(text){
  window.speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "es-ES";
  utter.rate = 1;
  window.speechSynthesis.speak(utter);
}

// --- AUDIO ---
function startAudio() {
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  // Sonido principal (bajo)
  mainTone = audioCtx.createOscillator();
  mainTone.type = "sine";
  mainTone.frequency.value = 150; // bajo
  const gain = audioCtx.createGain();
  gain.gain.value = 0.02; // volumen bajo
  mainTone.connect(gain);
  gain.connect(audioCtx.destination);
  mainTone.start();

  // Modulator para pitido intermitente (derecha)
  modulator = audioCtx.createOscillator();
  modulator.type = "sine";
  modulator.frequency.value = 0; // inicialmente apagado
  modGain = audioCtx.createGain();
  modGain.gain.value = 0;
  modulator.connect(modGain);
  modGain.connect(audioCtx.destination);
  modulator.start();
}

function updateAudio(angle, diff){
  if(!mainTone) return;
  if(diff <= STABLE_THRESHOLD){
    // estable → sonido bajo constante
    mainTone.frequency.value = 150;
    modGain.gain.value = 0;
    modulator.frequency.value = 0;
  }else{
    if((angle > lastAngle && diff < 180) || (angle < lastAngle && diff > 180)){
      // gira derecha → pitido intermitente
      mainTone.frequency.value = 400;
      modulator.frequency.value = 2; // 2Hz intermitente
      modGain.gain.value = 0.02;
    }else{
      // gira izquierda → pitido constante
      mainTone.frequency.value = 400;
      modGain.gain.value = 0; // no intermitente
      modulator.frequency.value = 0;
    }
  }
}

// --- CARDINALES ---
function drawCardinals(){
  const compass = document.getElementById("compass");
  const center = 150;
  const radius = 130;
  CARDINALS.forEach(c=>{
    const rad = c.angle*Math.PI/180;
    const x = center + radius*Math.sin(rad);
    const y = center - radius*Math.cos(rad);
    const div = document.createElement("div");
    div.className="cardinal";
    div.style.left = x+"px";
    div.style.top = y+"px";
    div.textContent = c.name;
    compass.appendChild(div);
  });
}

// --- ORIENTACIÓN ---
function handleOrientation(event){
  let angle = event.alpha;
  if(angle===null) return;
  angle = (angle+180)%360; // ajustar para que flecha apunte correcto
  angle = Math.round(angle);

  // --- AGUJA ---
  const needle = document.getElementById("needle");
  needle.style.transform = `rotate(${angle+180}deg)`; // +180 para que punta apunte hacia la mirada

  // --- AUDIO ---
  if(lastAngle!==null){
    const diff = Math.abs(angle-lastAngle);
    updateAudio(angle,diff);
  }

  // --- PUNTOS CARDINALES ---
  CARDINALS.forEach(c=>{
    const diff = Math.min(Math.abs(angle-c.angle),360-Math.abs(angle-c.angle));
    if(diff<10){ // cerca del cardinal
      if(!currentCardinal || currentCardinal.name!==c.name){
        currentCardinal = c;
        speak(c.name);
        if(speakInterval) clearInterval(speakInterval);
        speakInterval=setInterval(()=> speak(c.name),CARDINAL_REPEAT_INTERVAL);
        document.getElementById("directionText").textContent=c.name;
      }
    }
  });

  lastAngle = angle;
}

// --- INICIO ---
document.getElementById("startBtn").addEventListener("click", async ()=>{
  document.getElementById("startBtn").style.display="none";
  document.getElementById("compass").style.display="block";
  drawCardinals();
  startAudio();

  if(typeof DeviceOrientationEvent.requestPermission==="function"){
    const permission=await DeviceOrientationEvent.requestPermission();
    if(permission!=="granted"){ speak("Permiso denegado"); return; }
  }

  speak("Brújula iniciada");
  window.addEventListener("deviceorientation",handleOrientation);
});
</script>

</body>
</html>
