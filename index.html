<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Brújula Sonora</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { 
    font-family: 'Georgia', serif; 
    text-align: center; 
    background: #222; 
    color: #fff;
  }

  #startBtn { 
    font-size: 1.8em; 
    padding: 1em 2em; 
    margin-top: 2em; 
    border: none;
    border-radius: 12px;
    background: linear-gradient(145deg, #8B4513, #D2691E);
    color: white;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    transition: all 0.2s ease;
  }

  #startBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  }

  #compass { 
    margin: 2em auto; 
    width: 320px; 
    height: 320px; 
    position: relative; 
    border: 12px solid #C19A6B;
    border-radius: 50%; 
    background: radial-gradient(circle at center, #F5F5DC 60%, #D2B48C 100%);
    box-shadow: inset 0 0 15px rgba(0,0,0,0.3), 0 5px 20px rgba(0,0,0,0.5);
    overflow: hidden;
  }

  #needle { 
    width: 6px; 
    height: 140px; 
    position: absolute; 
    top: 20px; 
    left: 50%; 
    transform-origin: bottom center; 
    transition: transform 0.2s ease;
  }

  #needle::before {
    content:"";
    position: absolute;
    top:0;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 70px;
    background: red; 
    border-radius: 2px;
    box-shadow: 0 0 5px rgba(255,0,0,0.8);
  }

  #needle::after {
    content:"";
    position: absolute;
    bottom:0;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 70px;
    background: black;
    border-radius: 2px;
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
  }

  #cardinalsContainer {
    position:absolute;
    width:100%;
    height:100%;
    top:0; left:0;
  }

  .cardinal { 
    position:absolute; 
    font-weight:bold; 
    font-size:1.3em; 
    color: #333;
    text-shadow: 1px 1px 2px rgba(255,255,255,0.7);
    transform:translate(-50%,-50%);
  }

  .tick {
    position: absolute;
    width: 2px;
    height: 10px;
    background: #333;
    top: 10px;
    left: 50%;
    transform-origin: bottom center;
  }

  #directionText { 
    font-size: 2em; 
    margin-top: 1em; 
    color: #FFD700;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
  }
</style>
</head>
<body>

<button id="startBtn">Tocar para comenzar</button>
<div id="compass" style="display:none;">
  <div id="needle"></div>
  <div id="cardinalsContainer"></div>
</div>
<div id="directionText"></div>

<script>
let lastAngle = null;
let wakeLock = null;
let speakInterval = null;

// --- AUDIO CONTINUO ---
let audioCtx = null;
let mainTone = null;
let gainNode = null;

// --- CONFIGURACIÓN ---
const CARDINALS = [
  { name:"N", angle:0 },
  { name:"NE", angle:45 },
  { name:"E", angle:90 },
  { name:"SE", angle:135 },
  { name:"S", angle:180 },
  { name:"SO", angle:225 },
  { name:"O", angle:270 },
  { name:"NO", angle:315 }
];

const fullCardinalNames = {
  N: "Norte",
  NE: "Noreste",
  E: "Este",
  SE: "Sureste",
  S: "Sur",
  SO: "Suroeste",
  O: "Oeste",
  NO: "Noroeste"
};

// --- VOZ ---
function speak(text) {
  window.speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "es-ES";
  utter.rate = 1;
  utter.volume = 0.7;
  window.speechSynthesis.speak(utter);
}

// --- AUDIO CONTINUO ---
function startAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  
  mainTone = audioCtx.createOscillator();
  mainTone.type = "sine";
  mainTone.frequency.value = 150;

  gainNode = audioCtx.createGain();
  gainNode.gain.value = 0.4;

  mainTone.connect(gainNode);
  gainNode.connect(audioCtx.destination);
  mainTone.start();
}

// Convierte ángulo (0-360°) a frecuencia (150Hz → 1000Hz)
function angleToFrequency(angle) {
  const minFreq = 150;
  const maxFreq = 1000;
  return minFreq + (maxFreq - minFreq) * (angle / 360);
}

// --- DIBUJAR CARDINALES ---
function drawCardinals() {
  const container = document.getElementById("cardinalsContainer");
  const center = 160;
  const radius = 140;

  CARDINALS.forEach(c => {
    const rad = c.angle * Math.PI/180;
    const x = center + radius*Math.sin(rad);
    const y = center - radius*Math.cos(rad);
    const div = document.createElement("div");
    div.className = "cardinal";
    div.style.left = x+"px";
    div.style.top = y+"px";
    div.textContent = c.name;
    container.appendChild(div);
  });

  for(let i=0;i<360;i+=10){
    const tick = document.createElement("div");
    tick.className = "tick";
    tick.style.transform = `rotate(${i}deg) translateY(-150px)`;
    container.appendChild(tick);
  }
}

// --- FUNCIONES DE VOZ ---
function speakCurrentDirection(angle) {
  let closest = CARDINALS[0];
  let minDiff = 360;
  CARDINALS.forEach(c => {
    const diff = Math.min(Math.abs(angle - c.angle), 360 - Math.abs(angle - c.angle));
    if (diff < minDiff) {
      minDiff = diff;
      closest = c;
    }
  });
  const textToSpeak = `${fullCardinalNames[closest.name]}, ${angle} grados`;
  speak(textToSpeak);
}

// --- ORIENTACIÓN ---
function handleOrientation(event) {
  let angle = event.alpha;
  if (angle === null) return;

  angle = Math.round(angle); // usamos el ángulo real, sin sumar 180

  const container = document.getElementById("cardinalsContainer");
  container.style.transform = `rotate(${-angle}deg)`; // giramos el círculo, aguja apunta al Norte

  if (mainTone) {
    mainTone.frequency.setTargetAtTime(angleToFrequency(angle), audioCtx.currentTime, 0.05);
  }

  lastAngle = angle;

  let closest = CARDINALS[0];
  let minDiff = 360;
  CARDINALS.forEach(c => {
    const diff = Math.min(Math.abs(angle - c.angle), 360 - Math.abs(angle - c.angle));
    if (diff < minDiff) {
      minDiff = diff;
      closest = c;
    }
  });
  document.getElementById("directionText").textContent = `${fullCardinalNames[closest.name]} (${angle}°)`;
}

// --- WAKE LOCK ---
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', () => {
        console.log('Wake Lock liberado');
      });
    }
  } catch (err) {
    console.error(`${err.name}, ${err.message}`);
  }
}

document.addEventListener('visibilitychange', () => {
  if (wakeLock !== null && document.visibilityState === 'visible') {
    requestWakeLock();
  }
});

// --- INICIO ---
document.getElementById("startBtn").addEventListener("click", async () => {
  document.getElementById("startBtn").style.display="none";
  document.getElementById("compass").style.display="block";
  drawCardinals();
  startAudio();
  requestWakeLock();

  if (typeof DeviceOrientationEvent.requestPermission === "function") {
    const permission = await DeviceOrientationEvent.requestPermission();
    if (permission!=="granted") { speak("Permiso denegado"); return; }
  }

  speak("Brújula iniciada");

  window.addEventListener("deviceorientation", handleOrientation);

  if (!speakInterval) {
    speakInterval = setInterval(() => {
      if (lastAngle !== null) speakCurrentDirection(lastAngle);
    }, 3000);
  }
});
</script>

</body>
</html>
