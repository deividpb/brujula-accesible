<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Brújula Accesible</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family:sans-serif; text-align:center; background:#f0f0f0; }
  #startBtn { font-size:2em; padding:1em; margin-top:2em; }
  #compass { 
    margin:2em auto; 
    width:300px; 
    height:300px; 
    position:relative; 
    border:5px solid #333; 
    border-radius:50%; 
    background:radial-gradient(circle at center,#fff 70%,#ddd 100%);
    overflow: hidden;
  }
  #needle { 
    width:4px; 
    height:140px; 
    background:red; 
    position:absolute; 
    top:10px; 
    left:50%; 
    transform-origin:bottom center; 
  }
  #cardinalsContainer {
    position:absolute;
    width:100%;
    height:100%;
    top:0; left:0;
  }
  .cardinal { 
    position:absolute; 
    font-weight:bold; 
    font-size:1.2em; 
    transform:translate(-50%,-50%);
  }
  #directionText { font-size:2em; margin-top:1em; }
</style>
</head>
<body>

<button id="startBtn">Tocar para comenzar 9</button>
<div id="compass" style="display:none;">
  <div id="needle"></div>
  <div id="cardinalsContainer"></div>
</div>
<div id="directionText"></div>

<script>
let lastAngle = null;
let speakInterval = null;
let wakeLock = null;

// --- AUDIO ---
let audioCtx = null;
let mainTone = null;
let modulator = null;
let modGain = null;

// --- CONFIGURACIÓN ---
const STABLE_THRESHOLD = 2; 
const CARDINAL_REPEAT_INTERVAL = 3000; 
const CARDINALS = [
  { name:"Norte", angle:0 },
  { name:"NE", angle:45 },
  { name:"Este", angle:90 },
  { name:"SE", angle:135 },
  { name:"Sur", angle:180 },
  { name:"SO", angle:225 },
  { name:"Oeste", angle:270 },
  { name:"NO", angle:315 }
];

// --- VOZ ---
function speak(text) {
  window.speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "es-ES";
  utter.rate = 1;
  window.speechSynthesis.speak(utter);
}

// --- AUDIO ---
function startAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  mainTone = audioCtx.createOscillator();
  mainTone.type = "sine";
  mainTone.frequency.value = 150; 
  const gain = audioCtx.createGain();
  gain.gain.value = 0.02;
  mainTone.connect(gain);
  gain.connect(audioCtx.destination);
  mainTone.start();

  modulator = audioCtx.createOscillator();
  modulator.type = "sine";
  modulator.frequency.value = 0;
  modGain = audioCtx.createGain();
  modGain.gain.value = 0;
  modulator.connect(modGain);
  modGain.connect(audioCtx.destination);
  modulator.start();
}

function updateAudio(angle, diff) {
  if (!mainTone) return;
  if (diff <= STABLE_THRESHOLD) {
    mainTone.frequency.value = 150;
    modGain.gain.value = 0;
    modulator.frequency.value = 0;
  } else {
    if ((angle > lastAngle && diff < 180) || (angle < lastAngle && diff > 180)) {
      mainTone.frequency.value = 400;
      modulator.frequency.value = 2;
      modGain.gain.value = 0.02;
    } else {
      mainTone.frequency.value = 400;
      modulator.frequency.value = 0;
      modGain.gain.value = 0;
    }
  }
}

// --- DIBUJAR CARDINALES ---
function drawCardinals() {
  const container = document.getElementById("cardinalsContainer");
  const center = 150;
  const radius = 130;
  CARDINALS.forEach(c => {
    const rad = c.angle * Math.PI/180;
    const x = center + radius*Math.sin(rad);
    const y = center - radius*Math.cos(rad);
    const div = document.createElement("div");
    div.className = "cardinal";
    div.style.left = x+"px";
    div.style.top = y+"px";
    div.textContent = c.name;
    container.appendChild(div);
  });
}

// --- HABLAR CARDINAL + GRADOS ---
function speakCurrentDirection(angle) {
  let closest = CARDINALS[0];
  let minDiff = 360;
  CARDINALS.forEach(c => {
    const diff = Math.min(Math.abs(angle - c.angle), 360 - Math.abs(angle - c.angle));
    if (diff < minDiff) {
      minDiff = diff;
      closest = c;
    }
  });
  const textToSpeak = `${closest.name}, ${angle} grados`;
  document.getElementById("directionText").textContent = textToSpeak;
  speak(textToSpeak);
}

// --- ORIENTACIÓN ---
function handleOrientation(event) {
  let angle = event.alpha;
  if (angle === null) return;
  angle = (angle + 180) % 360;
  angle = Math.round(angle);

  const container = document.getElementById("cardinalsContainer");
  container.style.transform = `rotate(${-angle}deg)`;

  const needle = document.getElementById("needle");
  needle.style.transform = `rotate(${angle}deg)`;

  if (lastAngle !== null) {
    const diff = Math.abs(angle - lastAngle);
    updateAudio(angle, diff);
  }

  lastAngle = angle;

  if (!speakInterval) {
    speakInterval = setInterval(() => {
      speakCurrentDirection(lastAngle);
    }, CARDINAL_REPEAT_INTERVAL);
  }
}

// --- WAKE LOCK ---
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      console.log('Wake Lock activado');
      wakeLock.addEventListener('release', () => {
        console.log('Wake Lock liberado');
      });
    }
  } catch (err) {
    console.error(`${err.name}, ${err.message}`);
  }
}

document.addEventListener('visibilitychange', () => {
  if (wakeLock !== null && document.visibilityState === 'visible') {
    requestWakeLock();
  }
});

// --- INICIO ---
document.getElementById("startBtn").addEventListener("click", async () => {
  document.getElementById("startBtn").style.display="none";
  document.getElementById("compass").style.display="block";
  drawCardinals();
  startAudio();
  requestWakeLock(); // evita que la pantalla se apague

  if (typeof DeviceOrientationEvent.requestPermission === "function") {
    const permission = await DeviceOrientationEvent.requestPermission();
    if (permission!=="granted") { speak("Permiso denegado"); return; }
  }
  speak("Brújula iniciada");
  window.addEventListener("deviceorientation", handleOrientation);
});
</script>

</body>
</html>
