<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Brújula Accesible</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: sans-serif; text-align:center; background:#f0f0f0; }
  #startBtn { font-size:2em; padding:1em; margin-top:2em; }
  #compass { margin:2em auto; width:300px; height:300px; position:relative; border:5px solid #333; border-radius:50%; background:radial-gradient(circle at center,#fff 70%,#ddd 100%); }
  #needle { width:4px; height:140px; background:red; position:absolute; top:10px; left:50%; transform-origin:bottom center; transform:rotate(0deg); }
  .cardinal { position:absolute; font-weight:bold; font-size:1.5em; }
  #directionText { font-size:2em; margin-top:1em; }
</style>
</head>
<body>

<button id="startBtn">Tocar para comenzar</button>

<div id="compass" style="display:none;">
  <div id="needle"></div>
  <div class="cardinal" style="top:5px; left:50%; transform:translateX(-50%);">N</div>
  <div class="cardinal" style="top:50%; right:5px; transform:translateY(-50%);">E</div>
  <div class="cardinal" style="bottom:5px; left:50%; transform:translateX(-50%);">S</div>
  <div class="cardinal" style="top:50%; left:5px; transform:translateY(-50%);">O</div>
</div>
<div id="directionText"></div>

<script>
let lastAngle = null;
let currentDirection = null;
let speakInterval = null;

// --- AUDIO ---
let audioCtx = null;
let mainTone = null;
let modulator = null; // para pitido intermitente
let modGain = null;

// --- CONFIGURACIÓN ---
const STABLE_THRESHOLD = 2; // grados para considerar estable
const CARDINAL_REPEAT_INTERVAL = 4000; // ms para repetir voz cardinal
const DIRECTIONS = [
  { name: "Norte", min: 315, max: 360 },
  { name: "Norte", min: 0,   max: 45 },
  { name: "Este",  min: 45,  max: 135 },
  { name: "Sur",   min: 135, max: 225 },
  { name: "Oeste", min: 225, max: 315 }
];

// --- VOZ ---
function speak(text) {
  window.speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "es-ES";
  utter.rate = 1;
  window.speechSynthesis.speak(utter);
}

// --- AUDIO ---
function startAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  mainTone = audioCtx.createOscillator();
  mainTone.type = "sine";
  mainTone.frequency.value = 200; // tono base bajo
  const gain = audioCtx.createGain();
  gain.gain.value = 0.02; // volumen bajo

  mainTone.connect(gain);
  gain.connect(audioCtx.destination);
  mainTone.start();

  modulator = audioCtx.createOscillator();
  modulator.type = "sine";
  modulator.frequency.value = 0; // inicialmente apagado
  modGain = audioCtx.createGain();
  modGain.gain.value = 0;

  modulator.connect(modGain);
  modGain.connect(audioCtx.destination);
  modulator.start();
}

function stopAudio() {
  if (!audioCtx) return;
  mainTone.stop();
  modulator.stop();
  audioCtx.close();
  audioCtx = null;
}

// --- SONIDO SEGÚN MOVIMIENTO ---
function updateAudio(angle, diff) {
  if (!mainTone) return;

  if (diff <= STABLE_THRESHOLD) {
    // estable → sonido suave constante
    mainTone.frequency.value = 200;
    modGain.gain.value = 0;
  } else {
    if ((angle > lastAngle && diff < 180) || (angle < lastAngle && diff > 180)) {
      // gira derecha → pitido continuo más alto
      mainTone.frequency.value = 400;
      modGain.gain.value = 0; // sin modulador
    } else {
      // gira izquierda → pitido intermitente
      mainTone.frequency.value = 400;
      modulator.frequency.value = 2; // 2 Hz intermitente
      modGain.gain.value = 0.02;
    }
  }
}

// --- DIRECCIÓN ---
function getDirection(angle) {
  return DIRECTIONS.find(d => angle >= d.min && angle < d.max);
}

function startCardinalSpeech(direction) {
  if (speakInterval) clearInterval(speakInterval);
  speak(direction.name);
  speakInterval = setInterval(() => {
    speak(direction.name);
  }, CARDINAL_REPEAT_INTERVAL);
}

function stopCardinalSpeech() {
  if (speakInterval) clearInterval(speakInterval);
  speakInterval = null;
}

// --- ORIENTACIÓN ---
function handleOrientation(event) {
  let angle = event.alpha;
  if (angle === null) return;

  // corrección 180°
  angle = (angle + 180) % 360;
  angle = Math.round(angle);

  // --- AGUJA ---
  const needle = document.getElementById("needle");
  needle.style.transform = `rotate(${angle}deg)`;

  // --- MOVIMIENTO Y AUDIO ---
  if (lastAngle !== null) {
    let diff = Math.abs(angle - lastAngle);
    updateAudio(angle, diff);
  }

  // --- DIRECCIÓN CARDINAL ---
  const dir = getDirection(angle);
  if (dir && (!currentDirection || dir.name !== currentDirection.name)) {
    currentDirection = dir;
    startCardinalSpeech(dir);
    document.getElementById("directionText").textContent = dir.name;
  }

  lastAngle = angle;
}

// --- INICIO ---
document.getElementById("startBtn").addEventListener("click", async () => {
  document.getElementById("startBtn").style.display = "none";
  document.getElementById("compass").style.display = "block";

  // permiso iOS
  if (typeof DeviceOrientationEvent.requestPermission === "function") {
    const permission = await DeviceOrientationEvent.requestPermission();
    if (permission !== "granted") {
      speak("Permiso denegado");
      return;
    }
  }

  speak("Brújula iniciada");
  startAudio();
  window.addEventListener("deviceorientation", handleOrientation);
});
</script>

</body>
</html>
